{% load static i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="UTF-8">
  <title>{% trans "Statistics" %}</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <style>
    .profile-header{ font-size:22px !important; font-weight:900 !important; padding:18px 16px !important; border-radius:18px !important; text-align:center !important; }
    .tests-header{ margin-top:14px; font-weight:900; }

    .history-kind{ display:inline-block; padding:2px 10px; border-radius:999px; font-weight:900; font-size:12px; margin-bottom:6px; background:#e2e8f0; color:#0f172a; }
    .history-kind.basic{ background:#dcfce7; color:#14532d; }
    .history-kind.teacher{ background:#dbeafe; color:#1e3a8a; }

    .test-meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn-mini{
      display:inline-block;
      padding:6px 10px;
      border-radius:12px;
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      border:1px solid rgba(15,23,42,.15);
      background:#0b1220;
      color:#fff;
    }
  </style>
</head>
<body>

<div class="phone">
  <div class="phone__top"></div>

  <div class="screen">

    <div class="profile-header">{% trans "Statistics" %}</div>

    <form method="get" class="form-wrapper" id="statsForm">
      <input type="hidden" name="apply" id="applyFlag" value="0">

      <div class="form-group">
        <label class="form-label">{% trans "Select test" %}</label>
        <select name="test" class="form-input" id="selTest">
          <option value="all" {% if selected_test == "all" %}selected{% endif %}>{% trans "All tests" %}</option>

          {% if teacher_tests %}
            <optgroup label="{% trans 'Teacher tests' %}">
              {% for t in teacher_tests %}
                {% with tid=t.id|stringformat:"s" %}
                  {% with key="T-"|add:tid %}
                    <option value="{{ key }}" {% if selected_test == key %}selected{% endif %}>
                      {{ t.title }}
                    </option>
                  {% endwith %}
                {% endwith %}
              {% endfor %}
            </optgroup>
          {% endif %}

          {% if basic_tests %}
            <optgroup label="{% trans 'Basic tests' %}">
              {% for bt in basic_tests %}
                {% with key="B-"|add:bt.code %}
                  <option value="{{ key }}" {% if selected_test == key %}selected{% endif %}>
                    {{ bt.title }}
                  </option>
                {% endwith %}
              {% endfor %}
            </optgroup>
          {% endif %}
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">{% trans "Select group" %}</label>
        <select name="group" class="form-input" id="selGroup">
          <option value="all" {% if selected_group == "all" %}selected{% endif %}>{% trans "All groups" %}</option>
          {% for g in groups %}
            <option value="{{ g.id }}"
              {% if selected_group|stringformat:"s" == g.id|stringformat:"s" %}selected{% endif %}>
              {{ g.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">{% trans "Select student" %}</label>
        <select name="student" class="form-input" id="selStudent">
          <option value="all" {% if selected_student == "all" %}selected{% endif %}>{% trans "All students" %}</option>
          {% for s in students %}
            <option value="{{ s.id }}"
              {% if selected_student|stringformat:"s" == s.id|stringformat:"s" %}selected{% endif %}>
              {{ s.username }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button class="btn-primary" type="submit" id="btnShow">{% trans "Show" %}</button>
    </form>

    <div class="profile-stats">
      <div class="stat-card">
        <div class="stat-title">{% trans "Total attempts" %}</div>
        <div class="stat-value">{{ total_attempts|default:0 }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">{% trans "Average score" %}</div>
        <div class="stat-value">{{ avg_score|default:0|floatformat:1 }}</div>
      </div>
    </div>

    <div class="profile-stats">
      <div class="stat-card">
        <div class="stat-title">{% trans "Students" %}</div>
        <div class="stat-value">{{ students_count|default:0 }}</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">{% trans "Tests" %}</div>
        <div class="stat-value">{{ tests_count|default:0 }}</div>
      </div>
    </div>

    <div class="tests-header">{% trans "Attempts overview" %}</div>

    <div class="tests-list">
      {% for h in history %}
        <div class="test-item">
          <div class="history-kind {% if h.kind == 'basic' %}basic{% else %}teacher{% endif %}">
            {% if h.kind == "basic" %}{% trans "Basic" %}{% else %}{% trans "Teacher" %}{% endif %}
          </div>

          <div class="test-name">{{ h.title }}</div>

          <div class="test-meta">
            <span>{% trans "Student" %}: {{ h.student|default:"—" }}</span>
            <span>{% trans "Group" %}: {{ h.group|default:"—" }}</span>
          </div>

          <div class="test-meta">
            <span>{% trans "Topic" %}: {{ h.topic }}</span>
            <span>{% trans "Author" %}: {{ h.author|default:"—" }}</span>
            <span>{% trans "Score" %}: {{ h.score }} / 100</span>
            <span>{% trans "Date" %}: {{ h.dt|date:"d.m.Y H:i" }}</span>

            {% if h.kind == "teacher" %}
              <a class="btn-mini" href="{% url 'teacher_attempt_preview' h.attempt_id %}">{% trans "Preview" %}</a>
            {% else %}
              <a class="btn-mini" href="{% url 'teacher_basic_attempt_preview' h.attempt_id %}">{% trans "Preview" %}</a>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="small-text center">{% trans "No attempts yet." %}</p>
      {% endfor %}
    </div>

    <a href="{% url 'teacher_menu' %}" class="groups-btn-home">{% trans "Main menu" %}</a>

  </div>

  <div class="phone__bottom"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('statsForm');
  const apply = document.getElementById('applyFlag');
  const selGroup = document.getElementById('selGroup');
  const selStudent = document.getElementById('selStudent');
  const btnShow = document.getElementById('btnShow');

  if (selGroup) {
    selGroup.addEventListener('change', () => {
      if (selStudent) selStudent.value = "all";
      apply.value = "0";
      form.submit();
    });
  }

  if (btnShow) {
    btnShow.addEventListener('click', () => {
      apply.value = "1";
    });
  }
});
</script>

</body>
</html>
